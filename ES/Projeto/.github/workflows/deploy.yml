name: Deploy to Production

on:
  workflow_call:
    inputs:
      backend_image:
        description: 'Backend image to deploy'
        required: true
        type: string
      frontend_image:
        description: 'Frontend image to deploy'
        required: true
        type: string

env:
  REGISTRY: ghcr.io

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64, es-vm-ecommerce]

    steps:
      # ============================================
      # SETUP
      # ============================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: true

      - name: Load Environment Variables
        run: |
          if [ -f "${{ github.workspace }}/.env" ]; then
            echo "Loading environment variables from .env file..."
            export $(cat ${{ github.workspace }}/.env | grep -v '^#' | xargs)
            # Export to GITHUB_ENV for subsequent steps
            cat ${{ github.workspace }}/.env | grep -v '^#' | grep '=' >> $GITHUB_ENV
            echo "‚úÖ Environment variables loaded"
          else
            echo "‚ùå .env file not found! Please create one from .env.example"
            exit 1
          fi

      - name: Clean Terraform Cache
        working-directory: terraform
        run: |
          echo "üßπ Cleaning Terraform cache from previous runs..."
          rm -rf .terraform
          echo "‚úÖ Cache cleaned"

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Pull Images
        run: |
          echo "üì• Pulling images..."
          docker pull ${{ inputs.backend_image }}
          docker pull ${{ inputs.frontend_image }}
          echo "‚úÖ Images pulled successfully"

      # ============================================
      # PRE-DEPLOYMENT CHECKS
      # ============================================
      - name: Verify Infrastructure
        run: |
          echo "üîç Verifying infrastructure services..."

          # Check network
          if ! docker network inspect shophub-network >/dev/null 2>&1; then
            echo "‚ùå Network 'shophub-network' not found"
            echo "Run infrastructure setup workflow first!"
            exit 1
          fi
          echo "‚úÖ Network exists"

          # Check Keycloak
          if ! docker ps | grep -q shophub-keycloak; then
            echo "‚ö†Ô∏è  Keycloak not running"
            echo "Run infrastructure setup workflow first!"
            exit 1
          fi
          echo "‚úÖ Keycloak running"

          # Check Flagsmith
          if ! docker ps | grep -q shophub-flagsmith; then
            echo "‚ö†Ô∏è  Flagsmith not running"
            echo "Run infrastructure setup workflow first!"
            exit 1
          fi
          echo "‚úÖ Flagsmith running"

          # Check Ollama
          if ! docker ps | grep -q shophub-ollama; then
            echo "‚ö†Ô∏è  Ollama not running (will be started by Terraform)"
          else
            echo "‚úÖ Ollama running"
          fi

          echo "‚úÖ Infrastructure check passed"

      # ============================================
      # CLEANUP EXISTING DEPLOYMENT
      # ============================================
      - name: Cleanup Existing Application Containers
        run: |
          echo "üßπ Cleaning up existing application containers..."
          
          # Stop and remove application containers (NOT Keycloak/Flagsmith/Ollama)
          docker stop shophub-backend-1 shophub-backend-2 shophub-frontend-1 shophub-frontend-2 \
                      shophub-postgres shophub-nginx-lb shophub-otel-collector \
                      shophub-prometheus shophub-grafana 2>/dev/null || true
          
          docker rm -f shophub-backend-1 shophub-backend-2 shophub-frontend-1 shophub-frontend-2 \
                       shophub-postgres shophub-nginx-lb shophub-otel-collector \
                       shophub-prometheus shophub-grafana 2>/dev/null || true
          
          # NOTE: NOT removing volumes - they persist to keep database data between deploys
          # docker volume rm shophub-postgres-data 2>/dev/null || true
          
          echo "‚úÖ Application containers cleaned up (data preserved)"

      # ============================================
      # TERRAFORM SETUP
      # ============================================
      - name: Setup Terraform
        run: |
          REQUIRED_VERSION="1.14.1"
          CURRENT_VERSION=$(terraform version -json 2>/dev/null | jq -r '.terraform_version' || echo "none")

          if [ "$CURRENT_VERSION" != "$REQUIRED_VERSION" ]; then
            echo "üì¶ Installing Terraform $REQUIRED_VERSION (current: $CURRENT_VERSION)..."
            cd /tmp
            wget -q https://releases.hashicorp.com/terraform/${REQUIRED_VERSION}/terraform_${REQUIRED_VERSION}_linux_amd64.zip
            unzip -q terraform_${REQUIRED_VERSION}_linux_amd64.zip
            sudo mv terraform /usr/local/bin/
            rm terraform_${REQUIRED_VERSION}_linux_amd64.zip
          else
            echo "‚úÖ Terraform $REQUIRED_VERSION already installed"
          fi

          terraform version

      - name: Create Terraform Configuration
        working-directory: terraform
        run: |
          echo "üìù Creating Terraform configuration..."

          cat > terraform.tfvars <<EOF
          # Application Images
          backend_image  = "${{ inputs.backend_image }}"
          frontend_image = "${{ inputs.frontend_image }}"

          # Network Configuration
          deploy_host_ip = "${{ env.DEPLOY_HOST_IP }}"

          # Deployment Configuration
          project_name_prefix = "shophub"
          backend_port_start  = ${{ env.BACKEND_PORT_1 }}
          frontend_port_start = ${{ env.FRONTEND_PORT_1 }}
          replica_count       = 2

          # Database Configuration
          postgres_password = "${{ env.POSTGRES_PASSWORD }}"

          # CORS Configuration
          cors_allowed_origins = "${{ env.CORS_ALLOWED_ORIGINS }}"

          # Flagsmith Configuration (Backend)
          flagsmith_enabled         = "${{ env.FLAGSMITH_ENABLED }}"
          flagsmith_environment_key = "${{ env.FLAGSMITH_ENVIRONMENT_KEY }}"
          flagsmith_api_url         = "http://shophub-flagsmith:8000/api/v1"
          flagsmith_timeout         = "5s"

          # Flagsmith Configuration (Frontend)
          react_app_flagsmith_api_url          = "http://${{ env.DEPLOY_HOST_IP }}:8000${{ env.REACT_APP_FLAGSMITH_API_URL_PATH }}"
          react_app_flagsmith_environment_id   = "${{ env.REACT_APP_FLAGSMITH_ENVIRONMENT_ID }}"
          react_app_flagsmith_default_identity = "${{ env.REACT_APP_FLAGSMITH_DEFAULT_IDENTITY }}"
          react_app_flagsmith_enable_analytics = "${{ env.REACT_APP_FLAGSMITH_ENABLE_ANALYTICS }}"

          # OpenTelemetry Configuration
          otel_traces_endpoint  = "http://shophub-otel-collector:4317"
          otel_metrics_endpoint = "http://shophub-otel-collector:4317"
          EOF

          echo "‚úÖ Terraform configuration created"
          
      # ============================================
      # TERRAFORM DEPLOYMENT
      # ============================================
      - name: Terraform Init
        working-directory: terraform
        run: |
          echo "üîß Initializing Terraform..."
          terraform init

      - name: Terraform Plan
        working-directory: terraform
        run: |
          echo "üìã Creating deployment plan..."
          terraform plan -var-file=terraform.tfvars -out=tfplan

      - name: Terraform Apply
        working-directory: terraform
        run: |
          echo "üöÄ Deploying application..."
          terraform apply -auto-approve tfplan

          echo "‚úÖ Terraform deployment complete"

      # ============================================
      # POST-DEPLOYMENT HEALTH CHECKS
      # ============================================
      - name: Wait for Database
        run: |
          echo "‚è≥ Waiting for database..."
          timeout 60 bash -c 'until docker exec shophub-postgres pg_isready -U shophub_user 2>/dev/null; do sleep 2; done'
          echo "‚úÖ Database ready"

      - name: Wait for Backend
        run: |
          echo "‚è≥ Waiting for backend services..."

          for port in ${{ env.BACKEND_PORT_1 }} ${{ env.BACKEND_PORT_2 }}; do
            echo "Checking backend on port ${port}..."
            timeout 180 bash -c "
              until curl -sf http://localhost:${port}/actuator/health >/dev/null 2>&1; do
                echo 'Waiting for backend port ${port}...'
                sleep 5
              done
            "
            echo "‚úÖ Backend port ${port} ready"
          done

      - name: Wait for Frontend
        run: |
          echo "‚è≥ Waiting for frontend services..."

          for port in ${{ env.FRONTEND_PORT_1 }} ${{ env.FRONTEND_PORT_2 }}; do
            echo "Checking frontend on port ${port}..."
            timeout 90 bash -c "
              until curl -sf http://localhost:${port} >/dev/null 2>&1; do
                echo 'Waiting for frontend port ${port}...'
                sleep 3
              done
            "
            echo "‚úÖ Frontend port ${port} ready"
          done

      - name: Wait for Load Balancer
        run: |
          echo "‚è≥ Waiting for load balancer..."

          if ! docker ps | grep -q shophub-nginx-lb; then
            echo "‚ö†Ô∏è  Load balancer not found (optional)"
            exit 0
          fi

          timeout 60 bash -c "
            until curl -sf http://localhost:80 >/dev/null 2>&1; do
              echo 'Waiting for load balancer...'
              sleep 3
            done
          "
          echo "‚úÖ Load balancer ready"

      # ============================================
      # ENDPOINT VERIFICATION
      # ============================================
      - name: Test Backend Endpoints
        run: |
          echo "üß™ Testing backend endpoints..."

          # Test individual replicas
          for port in ${{ env.BACKEND_PORT_1 }} ${{ env.BACKEND_PORT_2 }}; do
            RESPONSE=$(curl -s -w "%{http_code}" -o /dev/null http://${{ env.DEPLOY_HOST_IP }}:${port}/api/products)

            if [ "$RESPONSE" != "200" ]; then
              echo "‚ùå Backend port ${port} returned HTTP $RESPONSE"
              exit 1
            fi
            echo "‚úÖ Backend port ${port}: OK"
          done

          # Test load balancer (if exists)
          if docker ps | grep -q shophub-nginx-lb; then
            RESPONSE=$(curl -s -w "%{http_code}" -o /dev/null http://${{ env.DEPLOY_HOST_IP }}/api/products)
            if [ "$RESPONSE" != "200" ]; then
              echo "‚ùå Load balancer returned HTTP $RESPONSE"
              exit 1
            fi
            echo "‚úÖ Load balancer: OK"
          fi

      - name: Test Frontend
        run: |
          echo "üß™ Testing frontend..."

          # Test individual replicas
          for port in ${{ env.FRONTEND_PORT_1 }} ${{ env.FRONTEND_PORT_2 }}; do
            RESPONSE=$(curl -s -w "%{http_code}" -o /dev/null http://${{ env.DEPLOY_HOST_IP }}:${port})

            if [ "$RESPONSE" != "200" ]; then
              echo "‚ùå Frontend port ${port} returned HTTP $RESPONSE"
              exit 1
            fi
            echo "‚úÖ Frontend port ${port}: OK"
          done

      # ============================================
      # DEPLOYMENT SUMMARY
      # ============================================
      - name: Deployment Summary
        if: always()
        run: |
          echo "=================================="
          echo "üìä DEPLOYMENT STATUS"
          echo "=================================="
          echo ""
          echo "üê≥ Running Containers:"
          docker ps --format "table {{.Names}}\t{{.Status}}" | grep shophub || echo "No containers found"
          echo ""
          echo "üåê Services:"
          echo "  Frontend:  http://${{ env.DEPLOY_HOST_IP }}"
          echo "  Backend:   http://${{ env.DEPLOY_HOST_IP }}/api"
          echo ""
          echo "üîÑ Backend Replicas:"
          echo "  Port ${{ env.BACKEND_PORT_1 }}: http://${{ env.DEPLOY_HOST_IP }}:${{ env.BACKEND_PORT_1 }}/api"
          echo "  Port ${{ env.BACKEND_PORT_2 }}: http://${{ env.DEPLOY_HOST_IP }}:${{ env.BACKEND_PORT_2 }}/api"
          echo ""
          echo "üîÑ Frontend Replicas:"
          echo "  Port ${{ env.FRONTEND_PORT_1 }}: http://${{ env.DEPLOY_HOST_IP }}:${{ env.FRONTEND_PORT_1 }}"
          echo "  Port ${{ env.FRONTEND_PORT_2 }}: http://${{ env.DEPLOY_HOST_IP }}:${{ env.FRONTEND_PORT_2 }}"
          echo ""
          echo "=================================="
